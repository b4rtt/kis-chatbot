// Příklad implementace rate limitingu s Vercel KV
// Pro použití:
// 1. npm install @vercel/kv
// 2. Vytvoř KV store v Vercel dashboardu
// 3. Přidej proměnné prostředí: KV_REST_API_URL, KV_REST_API_TOKEN
// 4. Přejmenuj tento soubor na rateLimitKV.ts a použij místo rateLimit.ts

import { kv } from "@vercel/kv";

type RateLimitEntry = {
  timestamps: number[];
};

export async function checkRateLimitKV(
  identifier: string,
  maxRequests: number,
  windowMs: number = 10 * 60 * 1000
): Promise<{ allowed: boolean; remaining: number; resetAt: number }> {
  const now = Date.now();
  const windowStart = now - windowMs;
  const key = `ratelimit:${identifier}`;

  try {
    // Načíst existující záznam z KV
    const entry = (await kv.get<RateLimitEntry>(key)) || { timestamps: [] };

    // Odstranit staré časové razítka
    entry.timestamps = entry.timestamps.filter((ts) => ts > windowStart);

    // Zkontrolovat limit PŘED přidáním nového požadavku
    const count = entry.timestamps.length;
    const allowed = count < maxRequests;

    // Přidat aktuální požadavek pouze pokud je povolen
    if (allowed) {
      entry.timestamps.push(now);
      // Uložit zpět do KV s TTL (time to live) = windowMs + 1 minuta pro bezpečnost
      await kv.set(key, entry, { ex: Math.ceil((windowMs + 60000) / 1000) });
    }

    const remaining = Math.max(0, maxRequests - (count + (allowed ? 1 : 0)));
    const resetAt = entry.timestamps.length > 0 
      ? entry.timestamps[0] + windowMs 
      : now + windowMs;

    return { allowed, remaining, resetAt };
  } catch (error) {
    console.error("KV rate limit error:", error);
    // Fallback: povolit požadavek pokud KV selže
    return { allowed: true, remaining: maxRequests, resetAt: now + windowMs };
  }
}

export function getIdentifier(req: Request | { headers: Headers }): string {
  const headers = req.headers;
  
  const forwarded = headers.get("x-forwarded-for");
  const realIp = headers.get("x-real-ip");
  const cfConnectingIp = headers.get("cf-connecting-ip");
  const vercelIp = headers.get("x-vercel-forwarded-for");
  
  const ip = forwarded?.split(",")[0]?.trim() || 
             realIp || 
             cfConnectingIp ||
             vercelIp ||
             "unknown";
  
  const userAgent = headers.get("user-agent") || "unknown";
  const userAgentHash = userAgent.length > 0 
    ? userAgent.substring(0, 20).replace(/[^a-zA-Z0-9]/g, "") 
    : "unknown";
  
  return `${ip}:${userAgentHash}`;
}

